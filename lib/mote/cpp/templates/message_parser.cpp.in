/**
 * message_parser.cpp
 *
 * Copyright (c) 2015 Kevin Laeufer <kevin.laeufer@rwth-aachen.de>
 *
 * This file is part of awap.
 */


#include "message_parser.hpp"
#include <hpp/ostfriesentee.hpp>
#include <jlib_awap-common.hpp>
#include "messages.hpp"

namespace awap {
namespace generated {
namespace MessageParserFactory {

static ostfriesentee::Infusion awapCommonInfusion{nullptr};
void setAwapCommonInfusion(ostfriesentee::Infusion& inf) {
	awapCommonInfusion = inf;
	dj_mem_addSafePointer((void**)&awapCommonInfusion);
}

%% for service in services
	%% for msg in service.messages
		%% if msg.fields|length == 0
ref_t {{service.name}}::createJava_{{ msg.name }}(const Slice<uint8_t> /*data*/)
		%% else
ref_t {{service.name}}::createJava_{{ msg.name }}(const Slice<uint8_t> data)
		%% endif
{
	using Message = ::awap::generated::message::{{ service.name }}::{{ msg.name }};
		%% if msg.fields|length == 0
	Message::JavaClass obj(awapCommonInfusion);
	// WARN: needs to be handed to java code before any java memory is allocated
	//       or else it will be garbage collected!
	return obj.getRef();
		%% else
	if(check(Message::Bytes <= data.length, Warning::MessageParserTooShort)) {
		// create java object
		Message::JavaClass obj(awapCommonInfusion);
		// this is safe, because we checked the length above
		auto structured_data = reinterpret_cast<Message*>(data.data);
		auto java_data = obj.getUnderlying();
		%% for field in msg.fields
		java_data->{{ field.name }} = structured_data->{{ field.name }};
		%% endfor
		// WARN: needs to be handed to java code before any java memory is allocated
		//       or else it will be garbage collected!
		return obj.getRef();
	} else {
		return 0;	// error
	}
		%% endif
}

		%% if msg.fields|length == 0
size_t {{service.name}}::fromJava_{{ msg.name }}(ref_t /*obj*/, const Slice<uint8_t> /*output*/)
{
	return 0;	// this message does have any content
}
		%% else
size_t {{service.name}}::fromJava_{{ msg.name }}(ref_t obj, const Slice<uint8_t> output)
{
	using Message = ::awap::generated::message::{{ service.name }}::{{ msg.name }};
	if(check(Message::Bytes <= output.length, Warning::MessageParserOutputTooSmall)) {
		auto java_data = static_cast<Message::JavaClass::UnderlyingType*>(REF_TO_VOIDP(obj));
		// this is safe, because we checked the length above
		auto structured_data = reinterpret_cast<Message*>(output.data);
		%% for field in msg.fields
		structured_data->{{ field.name }} = java_data->{{ field.name }};
		%% endfor
		return Message::Bits;
	} else {
		return 0;	// error, zero bits written
	}
}
		%% endif
	%% endfor
%% endfor

} // namespace MessageParser
} // namespace generated
} // namespace awap
